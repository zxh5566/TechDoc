【主从复制原理】

主库将变更写入到主库的binlog中

从库的IO进程读取主库binlog内容，放进自己的relay log中；

1、二进制日志点

2、GTID(Mysql>=5.7推荐使用)

从库的SQL进程执行relay log中的语句；



【主从配置步骤】

配置主从数据库服务器参数

在Master服务器上创建用于复制的数据库账号

备份Master服务器上的数据并初始化Slave服务器数据


### Master服务器配置 ###

log_bin = /data/mysql/slq_logt/mysql.bin

server_id = 100



### Slave服务器配置 ###

log_bin = /data/mysql/slq_logt/mysql.bin

server_id = 101

relay_log =  /data/mysql/slq_logt/relay.bin

read_only = on  super_read_only = on(mysql>=5.7)

skip_slave_start = on   

master_info_repository = TABLE

relay_log_info_repository = TABLE


【在MASTER服务器上建立复制账号】

用于IO进程连接Master服务器获取binlog日志

create user 'repl'@'ip段' identified by 'PassWord'; //建立复制账号

grant REPLICATION SLAVE on *.* to 'repl'@'ip段'; //需要REPLICATION SLAVE权限


【初始化Slave数据】

建议主从数据库服务器采用相同的Mysql版本

建议使用全库备份的方式初始化Slave数据

change master to 
   master_host = 'master_host_id',
   master_user = 'repl',
   master_password = 'password',
   master_log_file = 'mysql_log_file_name',
   master_log_pos = xxxxx;

start slave;

【启动基于GTID的复制链路】

GTDI:也就是全局事务ID

gtid_mode = on

enforce-gtid-consistency

log-slave-updates = on

change master to 
   master_host = 'master_host_id',
   master_user = 'repl',
   master_password = 'password',
   master_auto_position = 1

start slave;

【GTID复制的限制】

无法再使用Create table ...select建立表

无法在事务中使用create temporary table建立临时表

无法使用关联更新同时更新事务表和非事务表


【主主复制配置调整】

Mater数据库配置修改

auto_increment_increment = 2

auto_increment_offset = 1

1,3,5,7,9......

主备数据库配置修改

auto_increment_increment = 2

auto_increment_offset = 2

2,4,6,8,10.....

【keepalived简介】

Keepalived基于ARRP网络协议

yum install keepalived -y

/etc/keepalived/keepalived.conf